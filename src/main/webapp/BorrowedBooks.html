<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sách Đã Mượn - Library Manage App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; margin:0; padding:0; background:#e9efff; color:#333; height:100%; }
        .header { width:100%; height:20%; padding:20px 0; background:#457b9d; display:flex; align-items:center; flex-direction:column; }
        .header h1 { font-size:2em; color:#fff; margin:0; }
        .header-bottom h2 { font-size:1.5em; color:#fff; margin-top:10px; }
        .directory { width:13%; background:#457b9d; min-height:100vh; padding-top:20px; }
        .directory h1 { color:#fff; text-align:center; padding:10px 0; font-size:1.5em; background:#05a4e4; margin:0; }
        .directory ul { list-style:none; padding:0; }
        .directory li { padding:10px 0; text-align:center; }
        .directory a { color:#fff; text-decoration:none; font-size:1.1em; }
        .directory a:hover { color:#a8dadc; }
        .main-content { display:flex; }
        .content-area { flex:1; padding:20px; }
        .books-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
        .book-card { background:linear-gradient(135deg, #a8dadc 0%, #457b9d 100%); border-radius:15px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .book-card:hover { transform:translateY(-5px); }
        .book-card img { width:100%; height:300px; border-radius:10px; margin-bottom:15px; }
        .book-title { font-size:1.3em; font-weight:700; color:#1d3557; margin-bottom:10px; }
        .book-info { color:#1d3557; margin-bottom:5px; }
        .book-genres { background: rgba(255,255,255,0.7); border-radius:15px; padding:5px 10px; display:inline-block; margin:5px 5px 5px 0; font-size:0.9em; }
        .book-actions { margin-top:15px; text-align:center; }
        .return-btn { background-color:#1d3557; color:white; border:none; padding:8px 16px; border-radius:100px; cursor:pointer; transition:background-color 0.3s ease; }
        .return-btn:hover { background-color:#457b9d; }
        .loading, .no-books, .error { text-align:center; padding:40px; font-size:1.2em; }
        .loading { color:#457b9d; }
        .error { color:#721c24; background:#f8d7da; border-radius:10px; margin:20px; }
        .sort-container { margin:10px 0; text-align:right; }
        .sort-btn { padding:8px 15px; border-radius:20px; border:none; background:#1d3557; color:#fff; cursor:pointer; margin-left:5px; }
        .sort-btn:hover { background:#457b9d; }
    </style>
</head>
<body>
    <div class="header">
        <h1><img src="sachdamuon.png" alt="Borrowed Books Logo" style="width:100px;height:100px;"> Library Manage App</h1>
        <div class="header-bottom">
            <h2>Sách Đã Mượn</h2>
        </div>
    </div>
    <div class="main-content">
        <div class="directory">
            <h1>Thư Mục</h1>
            <ul>
                <li><a href="AddBook.html">Thêm Sách</a></li>
                <li><a href="AvailableBooks.html">Sách Trong Kho</a></li>
                <li><a href="Index.html">Trang Chủ</a></li>
            </ul>
        </div>
        <div class="content-area">
            <div class="sort-container">
                <span>Sắp xếp theo số lần mượn:</span>
                <button class="sort-btn" onclick="sortBooks(true)">Giảm dần</button>
                <button class="sort-btn" onclick="sortBooks(false)">Tăng dần</button>
            </div>
            <div id="loading" class="loading">Đang tải...</div>
            <div id="error" class="error" style="display:none;"></div>
            <div id="books-grid" class="books-grid" style="display:none;"></div>
        </div>
    </div>

    <script>
        let borrowedBooks = [];

        async function loadBorrowedBooks() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const booksGrid = document.getElementById('books-grid');
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            booksGrid.style.display = 'none';

            try {
                const response = await fetch('/api/books?type=borrowed');
                const result = await response.json();
                loadingDiv.style.display = 'none';

                if(result.success){
                    borrowedBooks = result.data;
                    renderBooks(borrowedBooks);
                } else {
                    errorDiv.textContent = result.message || 'Có lỗi xảy ra khi tải dữ liệu';
                    errorDiv.style.display = 'block';
                }
            } catch(error){
                loadingDiv.style.display = 'none';
                errorDiv.textContent = 'Lỗi kết nối: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function renderBooks(books){
            const booksGrid = document.getElementById('books-grid');
            if(books.length === 0){
                booksGrid.innerHTML = '<div class="no-books">Không có sách nào đang được mượn</div>';
            } else {
                booksGrid.innerHTML = books.map(book => `
                    <div class="book-card" data-book-id="${book.bookId}">
                        <img src="${book.imgUrl}" alt="${book.title}">
                        <div class="book-title">${book.title}</div>
                        <div class="book-info"><strong>Tác giả:</strong> ${book.author}</div>
                        <div class="book-info"><strong>Nhà xuất bản:</strong> ${book.publisher}</div>
                        <div class="book-info"><strong>Năm xuất bản:</strong> ${book.yearPublished}</div>
                        <div class="book-info"><strong>Số lần mượn:</strong> ${book.borrowCount}</div>
                        <div>${book.genres.map(genre => `<span class="book-genres">${genre}</span>`).join('')}</div>
                        <div class="book-actions">
                            <button class="return-btn" onclick="returnBook(event, '${book.bookId}')">➖ Trả sách</button>
                        </div>
                    </div>
                `).join('');
            }
            booksGrid.style.display = 'grid';
        }

        function sortBooks(descending){
            borrowedBooks.sort((a,b) => descending ? b.borrowCount - a.borrowCount : a.borrowCount - b.borrowCount);
            renderBooks(borrowedBooks);
        }

        async function returnBook(event, bookId){
            const button = event.target;
            button.disabled = true;
            button.textContent = '...';
            try {
                const data = new URLSearchParams();
                data.append('userId','U001'); // default test user
                data.append('bookId', bookId);

                const response = await fetch('/api/books/return',{
                    method:'POST',
                    headers: { 'Content-Type':'application/x-www-form-urlencoded' },
                    body: data.toString()
                });

                const result = await response.json();
                if(result.success){
                    alert(result.message);
                    await loadBorrowedBooks();
                } else {
                    alert(result.message || 'Không thể trả sách');
                    button.disabled = false;
                    button.textContent = '➖ Trả sách';
                }
            } catch(error){
                alert('Lỗi kết nối: ' + error.message);
                button.disabled = false;
                button.textContent = '➖ Trả sách';
            }
        }

        document.addEventListener('DOMContentLoaded', loadBorrowedBooks);
    </script>
</body>
</html>
